<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Analysis - Mortgage Payoff Calculator</title>
    <link rel="stylesheet" href="simple.min.css">
    <link rel="stylesheet" href="../app-theme.css">
    <style>
        body { background: var(--color-bg-white); display: block; }
        main { padding: 0 20px 20px; max-width: 1200px; margin: 0 auto; }
        header.app-header { background: var(--color-bg-white); border-bottom: 1px solid var(--color-border-light); padding: 8px 20px; text-align: left; }
        header.app-header h1 { font-size: 1.1rem; margin: 0; }
        header.app-header nav a { background: none; border: none; padding: 0; color: var(--color-primary); }
        header.app-header nav a:hover { background: none; text-decoration: underline; }
        .analysis-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--accent-bg);
            border: 1px solid var(--border);
            border-radius: var(--standard-border-radius);
        }
        .analysis-section h2 { margin-top: 0; color: var(--accent); }
        .chart-container {
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: var(--standard-border-radius);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: var(--standard-border-radius);
            text-align: center;
        }
        .stat-card .label { font-size: 0.85rem; color: #666; }
        .stat-card .value { font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0; }
        .stat-card .sublabel { font-size: 0.75rem; color: #999; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .neutral { color: #6c757d; }
        .note { font-style: italic; color: var(--text-light); font-size: 0.9rem; }
        table { width: 100%; margin: 1rem 0; }
        th, td { padding: 0.5rem; text-align: right; }
        th:first-child, td:first-child { text-align: left; }
        #loading { text-align: center; padding: 2rem; font-size: 1.2rem; }
        .form-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: end; margin-bottom: 1rem; }
        .form-row label { display: block; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-row input, .form-row select { padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; }
        .form-row button { padding: 0.5rem 1.5rem; }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-left">
            <h1>Risk Analysis</h1>
            <span class="subtitle">Win magnitude, worst cases, and outcome distributions</span>
        </div>
        <nav>
            <a href="https://marhar.github.io/">Home</a>
            <a href="./">Calculator</a>
            <a href="comprehensive-analysis.html">3D Analysis</a>
            <a href="catastrophic-risk.html">Catastrophic Risk</a>
        </nav>
    </header>

    <main>
        <p class="note">
            This analysis goes beyond win frequency to show the <strong>magnitude</strong> of outcomes:
            how much you win or lose with each strategy, worst-case scenarios, and outcome distributions.
        </p>

        <div class="analysis-section">
            <h2>Parameters</h2>
            <div class="form-row">
                <div>
                    <label for="balance">Balance ($)</label>
                    <input type="number" id="balance" value="300000" min="10000" step="10000">
                </div>
                <div>
                    <label for="rate">Mortgage Rate (%)</label>
                    <input type="number" id="rate" value="5.0" min="0" max="15" step="0.5">
                </div>
                <div>
                    <label for="term">Term (Years)</label>
                    <input type="number" id="term" value="30" min="1" max="30">
                </div>
                <div>
                    <button onclick="runAnalysis()">Analyze</button>
                </div>
            </div>
        </div>

        <div id="loading" style="display: none;">Calculating risk analysis...</div>

        <div id="results" style="display: none;">
            <!-- Summary Stats -->
            <div class="analysis-section">
                <h2>Summary Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Periods Analyzed</div>
                        <div class="value" id="totalPeriods">-</div>
                        <div class="sublabel">starting years</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Invest Win Rate</div>
                        <div class="value" id="investWinRate">-</div>
                        <div class="sublabel" id="investWinCount">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Payoff Win Rate</div>
                        <div class="value" id="payoffWinRate">-</div>
                        <div class="sublabel" id="payoffWinCount">-</div>
                    </div>
                </div>
            </div>

            <!-- Magnitude Analysis -->
            <div class="analysis-section">
                <h2>Win Magnitude Analysis</h2>
                <p class="note">When each strategy wins, by how much?</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Avg Advantage When Invest Wins</div>
                        <div class="value positive" id="avgInvestWin">-</div>
                        <div class="sublabel">net worth difference</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Avg Advantage When Payoff Wins</div>
                        <div class="value negative" id="avgPayoffWin">-</div>
                        <div class="sublabel">net worth difference</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Expected Value Difference</div>
                        <div class="value" id="expectedValue">-</div>
                        <div class="sublabel">invest − payoff (weighted avg)</div>
                    </div>
                </div>

                <h3>Extremes</h3>
                <table id="extremesTable">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Invest Strategy</th>
                            <th>Payoff Strategy</th>
                            <th>Difference</th>
                            <th>Year</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Regret Analysis -->
            <div class="analysis-section">
                <h2>Regret Analysis</h2>
                <p class="note">Maximum "money left on the table" by choosing each strategy</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Max Regret if You Invest</div>
                        <div class="value negative" id="maxRegretInvest">-</div>
                        <div class="sublabel" id="maxRegretInvestYear">worst case year</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Max Regret if You Payoff</div>
                        <div class="value negative" id="maxRegretPayoff">-</div>
                        <div class="sublabel" id="maxRegretPayoffYear">worst case year</div>
                    </div>
                </div>
            </div>

            <!-- Distribution Charts -->
            <div class="analysis-section">
                <h2>Outcome Distributions</h2>
                <div class="chart-container">
                    <h3>Final Net Worth Distribution</h3>
                    <div id="distributionChart" style="height: 400px;"></div>
                </div>
                <div class="chart-container">
                    <h3>Advantage Distribution (Invest − Payoff)</h3>
                    <div id="advantageChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Year-by-Year Table -->
            <div class="analysis-section">
                <h2>Year-by-Year Results</h2>
                <details>
                    <summary>View all periods</summary>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="yearTable">
                            <thead>
                                <tr>
                                    <th>Start Year</th>
                                    <th>Invest Net Worth</th>
                                    <th>Payoff Net Worth</th>
                                    <th>Winner</th>
                                    <th>Advantage</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </details>
            </div>

            <!-- Key Insights -->
            <div class="analysis-section">
                <h2>Key Insights</h2>
                <div id="insights"></div>
            </div>
        </div>
    </main>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="sp500_data.js"></script>
    <script src="mortgage.js"></script>
    <script src="app.js"></script>
    <script>
        function formatCurrency(val) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(val);
        }

        function runAnalysis() {
            const balance = parseFloat(document.getElementById('balance').value);
            const rate = parseFloat(document.getElementById('rate').value) / 100;
            const years = parseFloat(document.getElementById('term').value);

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            setTimeout(() => {
                const results = calculateAllScenarios(balance, rate, years);
                displayResults(results, rate, years);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
            }, 50);
        }

        function calculateAllScenarios(balance, rate, years) {
            const dataRange = getDataRange();
            const firstYear = parseInt(dataRange.firstDate.split('-')[0]);
            const lastYear = parseInt(dataRange.lastDate.split('-')[0]);
            const lastValidStartYear = lastYear - Math.ceil(years);

            const results = [];

            for (let startYear = firstYear; startYear <= lastValidStartYear; startYear++) {
                try {
                    const payoff = scenarioPayoffMortgage(balance, rate, years, balance, `${startYear}-01-01`);
                    const invest = scenarioInvestLumpSum(balance, rate, years, balance, `${startYear}-01-01`);

                    if (!payoff.truncated && !invest.truncated) {
                        const investNW = invest.finalNetWorth;
                        const payoffNW = payoff.finalNetWorth;
                        const advantage = investNW - payoffNW;

                        results.push({
                            year: startYear,
                            investNW,
                            payoffNW,
                            advantage,
                            winner: advantage > 0 ? 'Invest' : 'Payoff'
                        });
                    }
                } catch (e) {}
            }

            return results;
        }

        function displayResults(results, rate, years) {
            const n = results.length;
            if (n === 0) return;

            // Basic counts
            const investWins = results.filter(r => r.winner === 'Invest');
            const payoffWins = results.filter(r => r.winner === 'Payoff');

            document.getElementById('totalPeriods').textContent = n;
            document.getElementById('investWinRate').textContent = ((investWins.length / n) * 100).toFixed(1) + '%';
            document.getElementById('investWinCount').textContent = `${investWins.length} of ${n} periods`;
            document.getElementById('payoffWinRate').textContent = ((payoffWins.length / n) * 100).toFixed(1) + '%';
            document.getElementById('payoffWinCount').textContent = `${payoffWins.length} of ${n} periods`;

            // Magnitude analysis
            const avgInvestWin = investWins.length > 0
                ? investWins.reduce((s, r) => s + r.advantage, 0) / investWins.length
                : 0;
            const avgPayoffWin = payoffWins.length > 0
                ? payoffWins.reduce((s, r) => s + Math.abs(r.advantage), 0) / payoffWins.length
                : 0;
            const expectedValue = results.reduce((s, r) => s + r.advantage, 0) / n;

            document.getElementById('avgInvestWin').textContent = formatCurrency(avgInvestWin);
            document.getElementById('avgPayoffWin').textContent = formatCurrency(avgPayoffWin);

            const evEl = document.getElementById('expectedValue');
            evEl.textContent = formatCurrency(expectedValue);
            evEl.className = 'value ' + (expectedValue > 0 ? 'positive' : expectedValue < 0 ? 'negative' : 'neutral');

            // Extremes
            const sorted = [...results].sort((a, b) => a.advantage - b.advantage);
            const worstForInvest = sorted[0]; // Most negative advantage
            const bestForInvest = sorted[sorted.length - 1]; // Most positive advantage

            const investNWs = results.map(r => r.investNW);
            const payoffNWs = results.map(r => r.payoffNW);
            const minInvest = Math.min(...investNWs);
            const maxInvest = Math.max(...investNWs);
            const minPayoff = Math.min(...payoffNWs);
            const maxPayoff = Math.max(...payoffNWs);

            const minInvestYear = results.find(r => r.investNW === minInvest).year;
            const maxInvestYear = results.find(r => r.investNW === maxInvest).year;
            const minPayoffYear = results.find(r => r.payoffNW === minPayoff).year;
            const maxPayoffYear = results.find(r => r.payoffNW === maxPayoff).year;

            document.querySelector('#extremesTable tbody').innerHTML = `
                <tr>
                    <td>Best Outcome</td>
                    <td class="positive">${formatCurrency(maxInvest)}</td>
                    <td class="positive">${formatCurrency(maxPayoff)}</td>
                    <td>${formatCurrency(maxInvest - maxPayoff)}</td>
                    <td>${maxInvestYear} / ${maxPayoffYear}</td>
                </tr>
                <tr>
                    <td>Worst Outcome</td>
                    <td class="negative">${formatCurrency(minInvest)}</td>
                    <td class="negative">${formatCurrency(minPayoff)}</td>
                    <td>${formatCurrency(minInvest - minPayoff)}</td>
                    <td>${minInvestYear} / ${minPayoffYear}</td>
                </tr>
                <tr>
                    <td>Range (Best − Worst)</td>
                    <td>${formatCurrency(maxInvest - minInvest)}</td>
                    <td>${formatCurrency(maxPayoff - minPayoff)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Std Deviation</td>
                    <td>${formatCurrency(stdDev(investNWs))}</td>
                    <td>${formatCurrency(stdDev(payoffNWs))}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            `;

            // Regret analysis
            // Max regret if you invest = worst case where payoff would have been better
            const maxRegretInvest = Math.max(...results.filter(r => r.advantage < 0).map(r => Math.abs(r.advantage)), 0);
            const maxRegretInvestYear = results.find(r => Math.abs(r.advantage) === maxRegretInvest && r.advantage < 0)?.year || '-';

            // Max regret if you payoff = worst case where invest would have been better
            const maxRegretPayoff = Math.max(...results.filter(r => r.advantage > 0).map(r => r.advantage), 0);
            const maxRegretPayoffYear = results.find(r => r.advantage === maxRegretPayoff)?.year || '-';

            document.getElementById('maxRegretInvest').textContent = formatCurrency(maxRegretInvest);
            document.getElementById('maxRegretInvestYear').textContent = `Starting ${maxRegretInvestYear}`;
            document.getElementById('maxRegretPayoff').textContent = formatCurrency(maxRegretPayoff);
            document.getElementById('maxRegretPayoffYear').textContent = `Starting ${maxRegretPayoffYear}`;

            // Distribution charts
            renderDistributionChart(results);
            renderAdvantageChart(results);

            // Year table
            renderYearTable(results);

            // Insights
            generateInsights(results, rate, years, avgInvestWin, avgPayoffWin, expectedValue, maxRegretInvest, maxRegretPayoff);
        }

        function stdDev(arr) {
            const mean = arr.reduce((s, v) => s + v, 0) / arr.length;
            const sqDiffs = arr.map(v => Math.pow(v - mean, 2));
            return Math.sqrt(sqDiffs.reduce((s, v) => s + v, 0) / arr.length);
        }

        function renderDistributionChart(results) {
            const investNWs = results.map(r => r.investNW);
            const payoffNWs = results.map(r => r.payoffNW);

            const trace1 = {
                x: investNWs,
                name: 'Invest Strategy',
                type: 'histogram',
                opacity: 0.7,
                marker: { color: '#28a745' }
            };

            const trace2 = {
                x: payoffNWs,
                name: 'Payoff Strategy',
                type: 'histogram',
                opacity: 0.7,
                marker: { color: '#dc3545' }
            };

            const layout = {
                barmode: 'overlay',
                xaxis: { title: 'Final Net Worth ($)' },
                yaxis: { title: 'Number of Periods' },
                legend: { x: 0.7, y: 0.95 }
            };

            Plotly.newPlot('distributionChart', [trace1, trace2], layout, { responsive: true });
        }

        function renderAdvantageChart(results) {
            const advantages = results.map(r => r.advantage);

            const trace = {
                x: advantages,
                type: 'histogram',
                marker: {
                    color: advantages.map(a => a > 0 ? '#28a745' : '#dc3545')
                }
            };

            const layout = {
                xaxis: { title: 'Advantage (Invest − Payoff, $)' },
                yaxis: { title: 'Number of Periods' },
                shapes: [{
                    type: 'line',
                    x0: 0, x1: 0,
                    y0: 0, y1: 1,
                    yref: 'paper',
                    line: { color: 'black', width: 2, dash: 'dash' }
                }]
            };

            Plotly.newPlot('advantageChart', [trace], layout, { responsive: true });
        }

        function renderYearTable(results) {
            const tbody = document.querySelector('#yearTable tbody');
            tbody.innerHTML = results.map(r => `
                <tr>
                    <td>${r.year}</td>
                    <td>${formatCurrency(r.investNW)}</td>
                    <td>${formatCurrency(r.payoffNW)}</td>
                    <td class="${r.winner === 'Invest' ? 'positive' : 'negative'}">${r.winner}</td>
                    <td>${formatCurrency(Math.abs(r.advantage))}</td>
                </tr>
            `).join('');
        }

        function generateInsights(results, rate, years, avgInvestWin, avgPayoffWin, expectedValue, maxRegretInvest, maxRegretPayoff) {
            const investWins = results.filter(r => r.winner === 'Invest').length;
            const n = results.length;
            const investWinPct = (investWins / n) * 100;

            let html = '<ul>';

            // Win rate insight
            if (investWinPct > 60) {
                html += `<li><strong>Frequency favors investing:</strong> Investing won ${investWinPct.toFixed(0)}% of historical periods at ${(rate*100).toFixed(1)}% mortgage rate.</li>`;
            } else if (investWinPct < 40) {
                html += `<li><strong>Frequency favors payoff:</strong> Paying off won ${(100-investWinPct).toFixed(0)}% of historical periods at ${(rate*100).toFixed(1)}% mortgage rate.</li>`;
            } else {
                html += `<li><strong>Close call:</strong> Neither strategy dominates historically (${investWinPct.toFixed(0)}% invest wins).</li>`;
            }

            // Magnitude insight
            if (avgInvestWin > avgPayoffWin * 1.5) {
                html += `<li><strong>Invest wins bigger:</strong> When investing wins, it wins by ${formatCurrency(avgInvestWin)} on average, vs ${formatCurrency(avgPayoffWin)} when payoff wins.</li>`;
            } else if (avgPayoffWin > avgInvestWin * 1.5) {
                html += `<li><strong>Payoff wins bigger:</strong> When payoff wins, it wins by ${formatCurrency(avgPayoffWin)} on average, vs ${formatCurrency(avgInvestWin)} when invest wins.</li>`;
            }

            // Expected value
            if (Math.abs(expectedValue) > 10000) {
                const better = expectedValue > 0 ? 'investing' : 'paying off';
                html += `<li><strong>Expected value:</strong> On average across all periods, ${better} comes out ${formatCurrency(Math.abs(expectedValue))} ahead.</li>`;
            }

            // Regret insight
            html += `<li><strong>Maximum regret:</strong> If you invest and it's wrong, you could be ${formatCurrency(maxRegretInvest)} worse off. If you payoff and it's wrong, you could be ${formatCurrency(maxRegretPayoff)} worse off.</li>`;

            // Volatility insight
            const investNWs = results.map(r => r.investNW);
            const payoffNWs = results.map(r => r.payoffNW);
            const investStd = stdDev(investNWs);
            const payoffStd = stdDev(payoffNWs);

            if (investStd > payoffStd * 1.5) {
                html += `<li><strong>Volatility:</strong> Investing has ${(investStd/payoffStd).toFixed(1)}x more outcome variability than paying off—higher potential but more uncertainty.</li>`;
            }

            html += '</ul>';
            document.getElementById('insights').innerHTML = html;
        }

        // Auto-run on load
        document.addEventListener('DOMContentLoaded', runAnalysis);
    </script>
</body>
</html>
